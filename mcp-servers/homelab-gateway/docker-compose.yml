version: '3.8'

services:
  mcp-gateway:
    build: .
    container_name: homelab-mcp-gateway
    restart: unless-stopped
    env_file: .env
    environment:
      - ROLE=gateway
    deploy:
      resources:
        limits:
          cpus: '4'
          memory: 4G
    # ================================================================
    # TRAEFIK LABELS - DO NOT MODIFY
    # ================================================================
    # Cloudflare terminates SSL, forwards to Traefik on port 80.
    # The entrypoint is HTTP. Do NOT add any of these:
    #   - entrypoints=https    <- WRONG (must be http)
    #   - tls=true               <- WRONG
    #   - tls.certresolver        <- WRONG
    # The 3 labels below are ALL that is needed.
    # ================================================================
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.mcp-gateway.rule=Host(`your-domain.com`)"
      - "traefik.http.services.mcp-gateway.loadbalancer.server.port=3500"
    networks:
      - traefik_proxy

  kb-worker:
    build: .
    restart: unless-stopped
    env_file: .env
    environment:
      - ROLE=worker
      - KB_QUEUE_MAX_CONCURRENT=3
    deploy:
      replicas: 2
      resources:
        limits:
          cpus: '16'
          memory: 32G
    networks:
      - traefik_proxy

networks:
  traefik_proxy:
    external: true
